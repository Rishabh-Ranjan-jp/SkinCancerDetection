{% extends "base.html" %}

{% block title %}Dashboard - Skin Cancer Detection{% endblock %}

{% block content %}

<style>
    .dashboard-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 40px 20px;
    }
    
    .card-sleek {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        border: none;
        backdrop-filter: blur(10px);
    }
    
    .upload-section {
        padding: 60px 40px;
        text-align: center;
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    }
    
    .upload-zone {
        border: 3px dashed #667eea;
        border-radius: 12px;
        padding: 40px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(102, 126, 234, 0.05);
    }
    
    .upload-zone:hover {
        border-color: #764ba2;
        background: rgba(118, 75, 162, 0.1);
        transform: translateY(-2px);
    }
    
    .upload-zone.dragover {
        border-color: #764ba2;
        background: rgba(118, 75, 162, 0.15);
    }
    
    .upload-icon {
        font-size: 48px;
        margin-bottom: 20px;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
    }
    
    .spinner {
        border: 4px solid rgba(102, 126, 234, 0.2);
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .stage-indicator {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 10px;
        background: #f0f4ff;
        color: #667eea;
    }
    
    /* RESULT SECTIONS */
    .result-container {
        display: none;
        padding: 40px;
    }
    
    .result-header {
        margin-bottom: 30px;
    }
    
    .result-image {
        max-width: 300px;
        height: 300px;
        border-radius: 12px;
        margin: 20px 0;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    /* BENIGN RESULT */
    .benign-result {
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(56, 142, 60, 0.05) 100%);
        padding: 40px;
        border-radius: 16px;
        border-left: 6px solid #4CAF50;
        margin: 20px 0;
    }
    
    .benign-badge {
        display: inline-block;
        background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
        color: white;
        padding: 12px 30px;
        border-radius: 30px;
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 15px;
        box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
    }
    
    .benign-text {
        color: #2e7d32;
        font-size: 16px;
        margin-top: 10px;
        font-weight: 500;
    }
    
    /* MALIGNANT RESULT */
    .malignant-alert-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        max-width: 500px;
        display: none;
        animation: popupSlideIn 0.4s ease;
    }
    
    @keyframes popupSlideIn {
        from {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
    }
    
    .malignant-alert-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
    }
    
    .alert-icon {
        font-size: 60px;
        margin-bottom: 20px;
        animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    
    .alert-title {
        font-size: 24px;
        font-weight: 700;
        color: #d32f2f;
        margin-bottom: 10px;
    }
    
    .alert-message {
        color: #666;
        font-size: 14px;
        margin-bottom: 30px;
    }
    
    .malignant-result {
        background: linear-gradient(135deg, rgba(211, 47, 47, 0.1) 0%, rgba(198, 40, 40, 0.05) 100%);
        padding: 40px;
        border-radius: 16px;
        border-left: 6px solid #d32f2f;
        margin: 20px 0;
    }
    
    .malignant-badge {
        display: inline-block;
        background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
        color: white;
        padding: 12px 30px;
        border-radius: 30px;
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 15px;
        box-shadow: 0 8px 20px rgba(211, 47, 47, 0.3);
    }
    
    .condition-title {
        font-size: 20px;
        font-weight: 700;
        color: #d32f2f;
        margin: 20px 0 10px;
    }
    
    .severity-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin: 15px 0;
    }
    
    .severity-bar {
        height: 8px;
        background: #f0f0f0;
        border-radius: 4px;
        flex: 1;
        min-width: 150px;
        overflow: hidden;
    }
    
    .severity-fill {
        height: 100%;
        background: linear-gradient(90deg, #4CAF50 0%, #FFC107 50%, #d32f2f 100%);
        border-radius: 4px;
        transition: width 0.8s ease;
    }
    
    .confidence-text {
        font-size: 14px;
        font-weight: 600;
        color: #333;
    }
    
    .details-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        margin-top: 20px;
    }
    
    .details-title {
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
        color: #666;
        margin-bottom: 15px;
        letter-spacing: 0.5px;
    }
    
    .detail-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #e0e0e0;
        font-size: 13px;
    }
    
    .detail-item:last-child {
        border-bottom: none;
    }
    
    .detail-label {
        color: #666;
        font-weight: 600;
    }
    
    .detail-value {
        color: #333;
        font-weight: 700;
    }
    
    .button-group {
        display: flex;
        gap: 12px;
        margin-top: 30px;
    }
    
    .btn-primary-sleek {
        flex: 1;
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary-sleek:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary-sleek {
        flex: 1;
        padding: 12px 24px;
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-secondary-sleek:hover {
        background: #f0f4ff;
    }
    
    .camera-button {
        display: inline-block;
        margin-top: 20px;
        padding: 10px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .camera-button:hover {
        transform: translateY(-2px);
    }
    
    .error-message {
        display: none;
        background: #ffebee;
        color: #c62828;
        padding: 16px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #d32f2f;
    }
    
    .success-message {
        display: none;
        background: #e8f5e9;
        color: #2e7d32;
        padding: 16px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #4CAF50;
    }
    
    /* RISK LEVEL BADGES */
    .risk-badge {
        display: inline-block;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        margin-left: 8px;
    }
    
    .risk-low {
        background: rgba(76, 175, 80, 0.2);
        color: #2e7d32;
        border: 1px solid rgba(76, 175, 80, 0.4);
    }
    
    .risk-medium {
        background: rgba(255, 193, 7, 0.2);
        color: #ff8f00;
        border: 1px solid rgba(255, 193, 7, 0.4);
    }
    
    .risk-high {
        background: rgba(211, 47, 47, 0.2);
        color: #c62828;
        border: 1px solid rgba(211, 47, 47, 0.4);
    }
    
    .risk-warning {
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .risk-warning-low {
        background: rgba(76, 175, 80, 0.1);
        color: #2e7d32;
        border-left: 4px solid #4CAF50;
    }
    
    .risk-warning-medium {
        background: rgba(255, 193, 7, 0.1);
        color: #ff8f00;
        border-left: 4px solid #FFC107;
    }
    
    .risk-warning-high {
        background: rgba(211, 47, 47, 0.1);
        color: #c62828;
        border-left: 4px solid #d32f2f;
    }
    
    /* Camera specific styles */
    #cameraLoadingIndicator {
        display: none;
        text-align: center;
        padding: 40px;
    }
    
    #cameraResults {
        display: none;
        padding: 40px;
    }
    
    #cameraErrorMessage {
        display: none;
        background: #ffebee;
        color: #c62828;
        padding: 16px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #d32f2f;
    }
</style>

<div class="dashboard-container">
    <div class="container">
        <div class="card-sleek">
            <div class="upload-section">
                <h2 style="color: #333; margin-bottom: 10px;">üî¨ Skin Cancer Detection</h2>
                <p style="color: #999; margin-bottom: 30px;">Upload or capture an image for intelligent analysis</p>
                
                <!-- Hidden file input -->
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
                
                <!-- Upload Zone -->
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">üì∏</div>
                    <h4 style="color: #667eea; margin: 10px 0;">Click to upload or drag & drop</h4>
                    <p style="color: #999; font-size: 13px; margin: 0;">Supports: JPG, PNG, GIF, BMP</p>
                </div>
                
                <button class="camera-button" onclick="startCamera()">üì∑ Use Camera</button>
                
                <!-- Loading Spinner -->
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner"></div>
                    <p style="color: #667eea; font-weight: 600;">Analyzing image...</p>
                    <p style="color: #999; font-size: 13px;">Stage 1: Binary Classification</p>
                </div>
                
                <!-- Camera Loading Indicator -->
                <div class="loading-spinner" id="cameraLoadingIndicator">
                    <div class="spinner"></div>
                    <p style="color: #667eea; font-weight: 600;">Analyzing camera image...</p>
                    <p style="color: #999; font-size: 13px;">Processing captured image</p>
                </div>
                
                <!-- Camera Error Message -->
                <div class="error-message" id="cameraErrorMessage"></div>
                
                <!-- File Upload Error Message -->
                <div class="error-message" id="errorMessage"></div>
                
                <!-- Success Message -->
                <div class="success-message" id="successMessage"></div>
                
                <!-- Camera Results Container -->
                <div id="cameraResults"></div>
            </div>
            
            <!-- RESULT CONTAINER -->
            <div class="result-container" id="resultContainer">
                <!-- IMAGE PREVIEW -->
                <img id="resultImage" class="result-image" src="" alt="Uploaded image">
                
                <!-- BENIGN RESULT -->
                <div id="benignResult" class="benign-result" style="display: none;">
                    <div class="stage-indicator">‚úì STAGE 1 COMPLETE</div>
                    <div class="benign-badge">‚úì BENIGN</div>
                    <div class="benign-text">
                        <strong>Classification:</strong> This lesion appears to be benign<br>
                        <strong>Confidence:</strong> <span id="benignConfidence"></span>%
                    </div>
                </div>
                
                <!-- MALIGNANT RESULT -->
                <div id="malignantResult" class="malignant-result" style="display: none;">
                    <div class="stage-indicator">‚ö† MALIGNANT DETECTED</div>
                    <div class="malignant-badge">‚ö† MALIGNANT</div>
                    
                    <div class="condition-title" id="conditionTitle"></div>
                    
                    <!-- Risk Level Badge -->
                    <div id="riskLevelBadge" class="risk-badge" style="margin-bottom: 15px;"></div>
                    
                    <!-- Risk Warning -->
                    <div id="riskWarning" class="risk-warning" style="margin-bottom: 15px;"></div>
                    
                    <div class="severity-indicator">
                        <span class="detail-label">Confidence:</span>
                        <span class="confidence-text" id="confidencePercent"></span>
                        <div class="severity-bar">
                            <div class="severity-fill" id="severityFill" style="width: 0%;"></div>
                        </div>
                    </div>
                    
                    <div class="details-section">
                        <div class="details-title">üìä Classification Details</div>
                        <div class="detail-item">
                            <span class="detail-label">Binary Result:</span>
                            <span class="detail-value">Malignant</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Binary Confidence:</span>
                            <span class="detail-value" id="binaryConfidence"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Condition Type:</span>
                            <span class="detail-value" id="conditionType"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Classification Confidence:</span>
                            <span class="detail-value" id="classConfidence"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Risk Level:</span>
                            <span class="detail-value" id="riskLevelValue"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Risk Assessment:</span>
                            <span class="detail-value" id="riskDescription"></span>
                        </div>
                    </div>
                </div>
                
                <!-- ACTION BUTTONS -->
                <div class="button-group">
                    <button class="btn-primary-sleek" onclick="resetDashboard()">üîÑ New Analysis</button>
                    <button class="btn-secondary-sleek" onclick="goToHistory()">üìà View History</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MALIGNANT ALERT POPUP -->
<div class="malignant-alert-overlay" id="alertOverlay"></div>
<div class="malignant-alert-popup" id="alertPopup">
    <div class="alert-icon">‚ö†Ô∏è</div>
    <div class="alert-title">Malignant Detected</div>
    <div class="alert-message">
        The binary classifier has detected a malignant lesion.<br>
        Performing detailed multi-class analysis...
    </div>
    <div class="spinner" style="margin: 20px auto;"></div>
    <p style="color: #999; text-align: center; font-size: 12px;">This may take a few moments</p>
</div>

<!-- CAMERA MODAL -->
<div id="cameraModal" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.9);
    z-index: 1001;
    flex-direction: column;
    align-items: center;
    justify-content: center;
">
    <video id="cameraVideo" style="
        max-width: 90vw;
        max-height: 70vh;
        border-radius: 12px;
        margin-bottom: 20px;
    " autoplay playsinline></video>
    <div style="display: flex; gap: 12px;">
        <button class="btn-primary-sleek" onclick="captureFrame()" style="flex: 0;">üì∑ Capture</button>
        <button class="btn-secondary-sleek" onclick="closeCamera()" style="flex: 0; color: white; border-color: white;">‚úï Close</button>
    </div>
</div>

<canvas id="hiddenCanvas" style="display: none;"></canvas>

<script>
    // Global variables
    const uploadZone = document.getElementById('uploadZone');
    const imageInput = document.getElementById('imageInput');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const cameraLoadingIndicator = document.getElementById('cameraLoadingIndicator');
    const resultContainer = document.getElementById('resultContainer');
    const errorMessage = document.getElementById('errorMessage');
    const cameraErrorMessage = document.getElementById('cameraErrorMessage');
    const successMessage = document.getElementById('successMessage');
    const alertPopup = document.getElementById('alertPopup');
    const alertOverlay = document.getElementById('alertOverlay');
    const cameraModal = document.getElementById('cameraModal');
    
    // Camera App Object (from camera.js)
    const CameraApp = {
        video: null,
        canvas: null,
        ctx: null,
        stream: null,
        isRunning: false,
        
        init() {
            this.video = document.getElementById('cameraVideo');
            this.canvas = document.getElementById('hiddenCanvas');
            if (this.canvas) {
                this.ctx = this.canvas.getContext('2d');
            }
        },
        
        async startCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError('Camera API not supported. Please use Chrome, Firefox, or Safari.');
                return false;
            }
            
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };
                
                this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                this.video.srcObject = this.stream;
                this.isRunning = true;
                
                this.video.onloadedmetadata = () => {
                    this.video.play().catch(e => console.error('Play error:', e));
                };
                
                return true;
            } catch (err) {
                console.error('Camera error:', err);
                if (err.name === 'NotAllowedError') {
                    showError('Camera permission denied. Please allow camera access.');
                } else if (err.name === 'NotFoundError') {
                    showError('No camera device found.');
                } else if (err.name === 'NotReadableError') {
                    showError('Camera is already in use by another application.');
                } else {
                    showError('Failed to access camera: ' + err.message);
                }
                return false;
            }
        },
        
        capture() {
            if (!this.video || !this.stream || !this.isRunning) {
                showError('Camera not ready for capture');
                return null;
            }
            
            try {
                if (!this.canvas) {
                    this.canvas = document.getElementById('hiddenCanvas');
                }
                
                this.canvas.width = this.video.videoWidth;
                this.canvas.height = this.video.videoHeight;
                
                if (this.canvas.width === 0 || this.canvas.height === 0) {
                    showError('Video dimensions not ready');
                    return null;
                }
                
                if (!this.ctx) {
                    this.ctx = this.canvas.getContext('2d');
                }
                
                this.ctx.drawImage(this.video, 0, 0);
                const imageData = this.canvas.toDataURL('image/jpeg', 0.9);
                return imageData;
            } catch (error) {
                console.error('Error capturing image:', error);
                showError('Failed to capture image');
                return null;
            }
        },
        
        stop() {
            if (this.stream) {
                this.stream.getTracks().forEach(track => track.stop());
                this.stream = null;
            }
            this.isRunning = false;
        },
        
        isActive() {
            return this.isRunning && this.stream !== null;
        }
    };
    
    // Initialize CameraApp on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
        CameraApp.init();
    });
    
    // Upload Zone Events
    uploadZone.addEventListener('click', () => imageInput.click());
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
            imageInput.files = e.dataTransfer.files;
            handleImageUpload();
        }
    });
    
    imageInput.addEventListener('change', handleImageUpload);
    
    // File Upload Handler
    function handleImageUpload() {
        const file = imageInput.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('image', file);
        
        showLoading(true, 'file');
        
        fetch('/predict', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                handlePredictionResult(data);
            } else {
                showError(data.error || 'Prediction failed');
                showLoading(false, 'file');
            }
        })
        .catch(error => {
            showError('Network error: ' + error.message);
            showLoading(false, 'file');
        });
    }
    
    // Handle Prediction Results
    function handlePredictionResult(data) {
        // For file uploads, show the result image
        if (data.image_path) {
            const resultImg = document.getElementById('resultImage');
            resultImg.src = '/static/' + data.image_path;
        }
        
        // Show Stage 1: Binary Result
        const stage1 = data.stage1;
        showLoading(false, 'file');
        
        if (!stage1.is_malignant) {
            // BENIGN CASE
            document.getElementById('benignResult').style.display = 'block';
            document.getElementById('malignantResult').style.display = 'none';
            document.getElementById('benignConfidence').textContent = stage1.binary_confidence_percent.toFixed(1);
            resultContainer.style.display = 'block';
        } else {
            // MALIGNANT CASE - Show Alert Popup
            alertOverlay.style.display = 'block';
            alertPopup.style.display = 'block';
            
            // Wait 2 seconds, then show Stage 2 results
            setTimeout(() => {
                if (data.stage2) {
                    displayMalignantResults(stage1, data.stage2);
                    alertOverlay.style.display = 'none';
                    alertPopup.style.display = 'none';
                }
            }, 2000);
        }
    }
    
    // Display Malignant Results with Risk Assessment
    function displayMalignantResults(stage1, stage2) {
        document.getElementById('benignResult').style.display = 'none';
        document.getElementById('malignantResult').style.display = 'block';
        document.getElementById('conditionTitle').textContent = 'üî¥ ' + stage2.condition.toUpperCase();
        document.getElementById('binaryConfidence').textContent = stage1.binary_confidence_percent.toFixed(1) + '%';
        document.getElementById('classConfidence').textContent = stage2.confidence_percent.toFixed(1) + '%';
        document.getElementById('confidencePercent').textContent = stage2.confidence_percent.toFixed(1) + '%';
        document.getElementById('severityFill').style.width = stage2.confidence_percent + '%';
        document.getElementById('conditionType').textContent = stage2.condition;
        
        // Risk Assessment Display
        const riskLevelBadge = document.getElementById('riskLevelBadge');
        const riskWarning = document.getElementById('riskWarning');
        const riskLevelValue = document.getElementById('riskLevelValue');
        const riskDescription = document.getElementById('riskDescription');
        
        if (stage2.risk_level && stage2.risk_description) {
            // Set risk level badge
            riskLevelBadge.textContent = stage2.risk_level;
            riskLevelBadge.className = 'risk-badge ';
            
            // Set badge color based on risk level
            if (stage2.risk_level.includes('LOW')) {
                riskLevelBadge.className += 'risk-low';
            } else if (stage2.risk_level.includes('MEDIUM')) {
                riskLevelBadge.className += 'risk-medium';
            } else if (stage2.risk_level.includes('HIGH')) {
                riskLevelBadge.className += 'risk-high';
            }
            
            // Set risk warning
            riskWarning.textContent = stage2.risk_description;
            riskWarning.className = 'risk-warning ';
            
            // Set warning color based on risk level
            if (stage2.risk_level.includes('LOW')) {
                riskWarning.className += 'risk-warning-low';
            } else if (stage2.risk_level.includes('MEDIUM')) {
                riskWarning.className += 'risk-warning-medium';
            } else if (stage2.risk_level.includes('HIGH')) {
                riskWarning.className += 'risk-warning-high';
            }
            
            // Set detailed risk info
            riskLevelValue.textContent = stage2.risk_level;
            riskDescription.textContent = stage2.risk_description.replace(/üü¢|üü°|üî¥/g, '').trim();
        } else {
            // Fallback if risk data not available
            riskLevelBadge.style.display = 'none';
            riskWarning.style.display = 'none';
            riskLevelValue.textContent = 'Not assessed';
            riskDescription.textContent = 'Risk assessment data not available';
        }
        
        resultContainer.style.display = 'block';
        
        // Scroll to results
        resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    // Camera Functions
    function startCamera() {
        console.log('üì∑ Starting camera...');
        cameraModal.style.display = 'flex';
        CameraApp.startCamera().then(success => {
            if (!success) {
                cameraModal.style.display = 'none';
            }
        });
    }
    
    function closeCamera() {
        console.log('üî¥ Closing camera...');
        CameraApp.stop();
        cameraModal.style.display = 'none';
    }
    
    function captureFrame() {
        console.log('üì∏ Capturing frame...');
        const base64Image = CameraApp.capture();
        if (!base64Image) {
            showError('Failed to capture frame. Please ensure camera is active and try again.');
            return;
        }
        
        console.log('üì∏ Frame captured, closing camera...');
        closeCamera();
        
        // Send to backend for ensemble analysis
        console.log('üì§ Sending captured image for analysis...');
        analyzeCameraImage(base64Image);
    }
    
    // Camera Image Analysis
    function analyzeCameraImage(base64Image) {
        console.log('üîÑ Sending camera image for analysis...');
        showLoading(true, 'camera');
        hideCameraError();
        
        fetch('/predict-camera', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image: base64Image
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üìä Camera analysis complete:', data);
            showLoading(false, 'camera');
            
            if (data.success) {
                // For camera results, we need to create a temporary image preview
                const cameraResults = document.getElementById('cameraResults');
                cameraResults.innerHTML = `
                    <div style="text-align: center;">
                        <img src="${base64Image}" style="max-width: 300px; height: 300px; border-radius: 12px; margin: 20px 0;" alt="Camera capture">
                        <div id="cameraResultContent"></div>
                    </div>
                `;
                
                // Display the results
                displayCameraResults(data);
            } else {
                showCameraError(data.error || 'Prediction failed');
            }
        })
        .catch(error => {
            console.error('‚ùå Camera prediction error:', error);
            showCameraError('Network error: ' + error.message);
            showLoading(false, 'camera');
        });
    }
    
    // Display Camera Results
    function displayCameraResults(data) {
        const stage1 = data.stage1;
        const stage2 = data.stage2;
        
        const cameraResultContent = document.getElementById('cameraResultContent');
        let html = '';
        
        if (!stage1.is_malignant) {
            // BENIGN CASE
            html = `
                <div class="benign-result">
                    <div class="stage-indicator">‚úì STAGE 1 COMPLETE</div>
                    <div class="benign-badge">‚úì BENIGN</div>
                    <div class="benign-text">
                        <strong>Classification:</strong> This lesion appears to be benign<br>
                        <strong>Confidence:</strong> ${stage1.binary_confidence_percent.toFixed(1)}%
                    </div>
                </div>
            `;
        } else {
            // MALIGNANT CASE
            let riskBadgeClass = 'risk-medium';
            let riskWarningClass = 'risk-warning-medium';
            let riskLevel = stage2.risk_level || 'MEDIUM RISK';
            let riskDescription = stage2.risk_description || 'üü° Medium confidence - monitor closely';
            
            if (riskLevel.includes('LOW')) {
                riskBadgeClass = 'risk-low';
                riskWarningClass = 'risk-warning-low';
            } else if (riskLevel.includes('HIGH')) {
                riskBadgeClass = 'risk-high';
                riskWarningClass = 'risk-warning-high';
            }
            
            html = `
                <div class="malignant-result">
                    <div class="stage-indicator">‚ö† MALIGNANT DETECTED</div>
                    <div class="malignant-badge">‚ö† MALIGNANT</div>
                    <div class="condition-title">üî¥ ${stage2.condition.toUpperCase()}</div>
                    
                    <div class="risk-badge ${riskBadgeClass}" style="margin-bottom: 15px;">
                        ${riskLevel}
                    </div>
                    
                    <div class="risk-warning ${riskWarningClass}" style="margin-bottom: 15px;">
                        ${riskDescription}
                    </div>
                    
                    <div class="severity-indicator">
                        <span class="detail-label">Confidence:</span>
                        <span class="confidence-text">${stage2.confidence_percent.toFixed(1)}%</span>
                        <div class="severity-bar">
                            <div class="severity-fill" style="width: ${stage2.confidence_percent}%;"></div>
                        </div>
                    </div>
                    
                    <div class="details-section">
                        <div class="details-title">üìä Classification Details</div>
                        <div class="detail-item">
                            <span class="detail-label">Binary Result:</span>
                            <span class="detail-value">Malignant</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Binary Confidence:</span>
                            <span class="detail-value">${stage1.binary_confidence_percent.toFixed(1)}%</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Condition Type:</span>
                            <span class="detail-value">${stage2.condition}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Classification Confidence:</span>
                            <span class="detail-value">${stage2.confidence_percent.toFixed(1)}%</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Risk Level:</span>
                            <span class="detail-value">${riskLevel}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Risk Assessment:</span>
                            <span class="detail-value">${riskDescription.replace(/üü¢|üü°|üî¥/g, '').trim()}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        cameraResultContent.innerHTML = html;
        
        // Add action buttons for camera results
        const actionButtons = document.createElement('div');
        actionButtons.className = 'button-group';
        actionButtons.style.marginTop = '30px';
        actionButtons.innerHTML = `
            <button class="btn-primary-sleek" onclick="resetDashboard()">üîÑ New Analysis</button>
            <button class="btn-secondary-sleek" onclick="goToHistory()">üìà View History</button>
        `;
        
        cameraResultContent.appendChild(actionButtons);
        
        // Show camera results
        document.getElementById('cameraResults').style.display = 'block';
    }
    
    // Utility Functions
    function showLoading(show, type = 'file') {
        if (type === 'camera') {
            cameraLoadingIndicator.style.display = show ? 'block' : 'none';
        } else {
            loadingSpinner.style.display = show ? 'block' : 'none';
        }
        
        uploadZone.style.pointerEvents = show ? 'none' : 'auto';
        uploadZone.style.opacity = show ? '0.5' : '1';
    }
    
    function showError(msg) {
        errorMessage.textContent = '‚ùå ' + msg;
        errorMessage.style.display = 'block';
        setTimeout(() => {
            errorMessage.style.display = 'none';
        }, 5000);
    }
    
    function showCameraError(msg) {
        cameraErrorMessage.textContent = '‚ùå ' + msg;
        cameraErrorMessage.style.display = 'block';
        setTimeout(() => {
            cameraErrorMessage.style.display = 'none';
        }, 5000);
    }
    
    function hideCameraError() {
        cameraErrorMessage.style.display = 'none';
    }
    
    function resetDashboard() {
        imageInput.value = '';
        resultContainer.style.display = 'none';
        document.getElementById('benignResult').style.display = 'none';
        document.getElementById('malignantResult').style.display = 'none';
        document.getElementById('cameraResults').style.display = 'none';
        document.getElementById('cameraResults').innerHTML = '';
        uploadZone.style.pointerEvents = 'auto';
        uploadZone.style.opacity = '1';
    }
    
    function goToHistory() {
        window.location.href = '/history';
    }
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        CameraApp.stop();
    });
</script>

{% endblock %}
